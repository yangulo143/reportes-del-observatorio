"0","# --- 2. CARGA DE DATOS ---"
"0",""
"0","# Intentamos leer el archivo. "
"0","# IMPORTANTE: Scopus a veces usa comas (,) y a veces punto y coma (;)"
"0","# Aquí intentamos leer con coma. Si tu tabla sale mal, cambia read_csv por read_csv2"
"0","tryCatch({"
"0","  raw_data <- read_csv(""scopus3.csv"", show_col_types = FALSE)"
"0","}, error = function(e) {"
"0","  stop(""No se encontró el archivo 'scopus3.csv' en la carpeta del proyecto."")"
"0","})"
"0",""
"0","# Limpiamos nombres de columnas (ej. ""Source title"" -> ""source_title"")"
"0","data_clean <- raw_data %>% "
"0","  clean_names()"
"0",""
"0","# --- 3. FILTROS Y TRANSFORMACIÓN ---"
"0",""
"0","# A. Filtro de Año (Hasta 2025)"
"0","data <- data_clean %>%"
"0","  filter(year <= 2025) %>%"
"0","  filter(!is.na(year)) # Eliminamos registros sin año"
"0",""
"0","# B. Lógica para Extraer Países (Para el Mapa)"
"0","# Función auxiliar para buscar países dentro del texto de afiliación"
"0","get_countries <- function(text) {"
"0","  if (is.na(text)) return(NA)"
"0","  # Lista de países en inglés (Scopus usa inglés)"
"0","  ref_countries <- countrycode::codelist$country.name.en"
"0","  # Buscamos coincidencias"
"0","  found <- str_extract_all(text, paste(ref_countries, collapse = ""|""))[[1]]"
"0","  if (length(found) == 0) return(NA)"
"0","  # Convertimos a ISO3 para estandarizar (ej. USA -> USA, United States -> USA)"
"0","  iso <- countrycode(unique(found), origin = ""country.name"", destination = ""iso3c"", warn = FALSE)"
"0","  return(unique(iso[!is.na(iso)]))"
"0","}"
"0",""
"0","# Procesamos las afiliaciones (esto puede tardar unos segundos)"
"0","data_processed <- data %>%"
"0","  mutate("
"0","    # Extraer códigos de país"
"0","    countries_iso = map(affiliations, get_countries),"
"0","    # Contar autores (aproximación por comas si existe la columna authors)"
"0","    n_authors = str_count(authors, "","") + 1,"
"0","    # Definir colaboración"
"0","    n_countries_distinct = map_int(countries_iso, length),"
"0","    collab_type = if_else(n_countries_distinct > 1, ""Internacional"", ""Nacional/Individual"")"
"0","  )"
"0",""
"0","# C. Crear Dataframe para el Mapa"
"0","map_data <- data_processed %>%"
"0","  select(countries_iso) %>%"
"0","  unnest(countries_iso) %>%"
"0","  count(countries_iso, name = ""documents"") %>%"
"0","  mutate(country_name = countrycode(countries_iso, origin = ""iso3c"", destination = ""country.name"")) %>%"
"0","  drop_na()"
"0",""
"0","# D. Crear Dataframe para Palabras Clave"
"0","keywords_df <- data %>%"
"0","  select(author_keywords) %>%"
"0","  drop_na() %>%"
"0","  separate_rows(author_keywords, sep = "";"") %>%"
"0","  mutate(word = str_to_lower(str_trim(author_keywords))) %>%"
"0","  count(word, sort = TRUE) %>%"
"0","  slice_head(n = 150) # Top 150 para la nube"
"0",""
"0","# E. Crear Dataframe de Tendencia"
"0","trend_data <- data_processed %>%"
"0","  count(year) %>%"
"0","  mutate("
"0","    growth = (n - lag(n))/lag(n),"
"0","    growth_txt = scales::percent(growth, accuracy = 0.1)"
"0","  )"
