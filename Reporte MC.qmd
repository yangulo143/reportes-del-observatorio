---
title: "Informe Bibliométrico de Producción Científica"
subtitle: "Análisis Dinámico de Resultados (Scopus)"
date: last-modified
author: "Unidad de Bibliometría"
format:
  html:
    theme: cosmo
    toc: true
    toc-title: "Índice"
    toc-depth: 2
    number-sections: true
    code-fold: true
    self-contained: true
    page-layout: full
---

```{r setup, include=FALSE}
# --- 1. CONFIGURACIÓN E INSTALACIÓN DE LIBRERÍAS ---
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

# Lista de paquetes necesarios
# Si no tienes alguno instalado, RStudio te sugerirá instalarlo o usa: install.packages("nombre")
library(tidyverse)    # Manipulación de datos
library(janitor)      # Limpieza de nombres de columnas
library(lubridate)    # Manejo de fechas
library(plotly)       # Gráficos interactivos
library(DT)           # Tablas interactivas
library(wordcloud2)   # Nube de palabras
library(countrycode)  # Estandarización de nombres de países
library(stringr)      # Manejo de texto avanzado
```

```{r carga_y_procesamiento}
# --- 2. CARGA DE DATOS ---

# Intentamos leer el archivo. 
# IMPORTANTE: Scopus a veces usa comas (,) y a veces punto y coma (;)
# Aquí intentamos leer con coma. Si tu tabla sale mal, cambia read_csv por read_csv2
tryCatch({
  raw_data <- read_csv("scopus3.csv", show_col_types = FALSE)
}, error = function(e) {
  stop("No se encontró el archivo 'scopus3.csv' en la carpeta del proyecto.")
})

# Limpiamos nombres de columnas (ej. "Source title" -> "source_title")
data_clean <- raw_data %>% 
  clean_names()

# --- 3. FILTROS Y TRANSFORMACIÓN ---

# A. Filtro de Año (Hasta 2025)
data <- data_clean %>%
  filter(year <= 2025) %>%
  filter(!is.na(year)) # Eliminamos registros sin año

# B. Lógica para Extraer Países (Para el Mapa)
# Función auxiliar para buscar países dentro del texto de afiliación
get_countries <- function(text) {
  if (is.na(text)) return(NA)
  # Lista de países en inglés (Scopus usa inglés)
  ref_countries <- countrycode::codelist$country.name.en
  # Buscamos coincidencias
  found <- str_extract_all(text, paste(ref_countries, collapse = "|"))[[1]]
  if (length(found) == 0) return(NA)
  # Convertimos a ISO3 para estandarizar (ej. USA -> USA, United States -> USA)
  iso <- countrycode(unique(found), origin = "country.name", destination = "iso3c", warn = FALSE)
  return(unique(iso[!is.na(iso)]))
}

# Procesamos las afiliaciones (esto puede tardar unos segundos)
data_processed <- data %>%
  mutate(
    # Extraer códigos de país
    countries_iso = map(affiliations, get_countries),
    # Contar autores (aproximación por comas si existe la columna authors)
    n_authors = str_count(authors, ",") + 1,
    # Definir colaboración
    n_countries_distinct = map_int(countries_iso, length),
    collab_type = if_else(n_countries_distinct > 1, "Internacional", "Nacional/Individual")
  )

# C. Crear Dataframe para el Mapa
map_data <- data_processed %>%
  select(countries_iso) %>%
  unnest(countries_iso) %>%
  count(countries_iso, name = "documents") %>%
  mutate(country_name = countrycode(countries_iso, origin = "iso3c", destination = "country.name")) %>%
  drop_na()

# D. Crear Dataframe para Palabras Clave
keywords_df <- data %>%
  select(author_keywords) %>%
  drop_na() %>%
  separate_rows(author_keywords, sep = ";") %>%
  mutate(word = str_to_lower(str_trim(author_keywords))) %>%
  count(word, sort = TRUE) %>%
  slice_head(n = 150) # Top 150 para la nube

# E. Crear Dataframe de Tendencia
trend_data <- data_processed %>%
  count(year) %>%
  mutate(
    growth = (n - lag(n))/lag(n),
    growth_txt = scales::percent(growth, accuracy = 0.1)
  )
```

# Resumen Ejecutivo

::: {.callout-note}
**Ficha del Análisis:**
Este reporte analiza la producción científica contenida en el archivo `scopus3.csv`. Se han incluido exclusivamente las publicaciones realizadas hasta el año **2025**.
:::

Resumen de indicadores principales:

| Indicador | Cantidad |
|:----------|:---------|
| **Total Documentos** | `r nrow(data_processed)` |
| **Revistas (Fuentes)** | `r n_distinct(data_processed$source_title)` |
| **Años cubiertos** | `r min(data_processed$year)` - `r max(data_processed$year)` |
| **Países detectados** | `r nrow(map_data)` |

# Análisis Temporal

Dinámica de publicación anual. Pase el cursor sobre los puntos para ver la tasa de crecimiento anual.

```{r}
#| label: fig-trend
#| fig-cap: "Tendencia de producción por año"

p1 <- ggplot(trend_data, aes(x = year, y = n)) +
  geom_area(fill = "#e3f2fd", alpha = 0.5) +
  geom_line(color = "#1565c0", size = 1) +
  geom_point(aes(text = paste("Año:", year, "<br>Docs:", n, "<br>Crecimiento:", growth_txt)), 
             color = "#0d47a1", size = 2) +
  theme_minimal() +
  labs(x = "Año", y = "Documentos")

ggplotly(p1, tooltip = "text")
```

# Distribución Geográfica

Mapa de calor que representa la intensidad de producción científica por país de afiliación institucional.

```{r}
#| label: fig-map
#| fig-height: 8

g_geo <- list(
  showframe = FALSE,
  showcoastlines = TRUE,
  projection = list(type = 'mercator')
)

plot_ly(map_data, 
        type = 'choropleth', 
        locations = ~countries_iso, 
        z = ~documents, 
        text = ~country_name, 
        colorscale = 'Viridis',
        marker = list(line = list(color = toRGB("white"), width = 0.5)),
        colorbar = list(title = 'N° Docs')) %>%
  layout(geo = g_geo,
         margin = list(l=0, r=0, t=0, b=0))
```

# Características de la Producción

## Revistas y Tipología

```{r}
#| layout-nrow: 2

# Gráfico 1: Revistas
p_source <- data_processed %>%
  count(source_title) %>%
  slice_max(n, n = 10) %>%
  ggplot(aes(x = reorder(source_title, n), y = n)) +
  geom_col(fill = "#2c3e50") +
  coord_flip() +
  theme_minimal() +
  labs(title = "Top 10 Revistas", x = "", y = "Docs")

ggplotly(p_source)

# Gráfico 2: Tipos de Documento
p_type <- data_processed %>%
  count(document_type) %>%
  ggplot(aes(x = reorder(document_type, n), y = n, fill = document_type)) +
  geom_col(show.legend = FALSE) +
  coord_flip() +
  theme_minimal() +
  labs(title = "Tipos de Documento", x = "", y = "Docs")

ggplotly(p_type)
```

## Colaboración y Financiamiento

```{r}
#| layout-ncol: 2

# Gráfico 3: Colaboración
p_collab <- data_processed %>%
  count(collab_type) %>%
  plot_ly(labels = ~collab_type, values = ~n, type = 'pie',
          textposition = 'inside',
          textinfo = 'label+percent',
          marker = list(colors = c('#e74c3c', '#95a5a6'))) %>%
  layout(title = "Colaboración Internacional vs Nacional", showlegend = FALSE)

p_collab

# Gráfico 4: Financiamiento (Detectado por campo Funding Details)
p_fund <- data_processed %>%
  mutate(funding_status = if_else(!is.na(funding_texts), "Con Financiamiento", "Sin Financiamiento")) %>%
  count(funding_status) %>%
  plot_ly(labels = ~funding_status, values = ~n, type = 'pie',
          hole = 0.4,
          marker = list(colors = c('#27ae60', '#ecf0f1'))) %>%
  layout(title = "Presencia de Financiamiento", showlegend = FALSE)

p_fund
```

# Nube de Palabras Clave

Conceptos más frecuentes encontrados en las palabras clave de los autores.

```{r}
#| label: fig-cloud
wordcloud2(keywords_df, size = 0.6, color = "random-dark")
```

# Tabla de Datos

A continuación se presentan los registros incluidos en el análisis. Puede filtrar, buscar y descargar la tabla.

```{r}
display_table <- data_processed %>%
  select(year, source_title, document_type, authors, affiliations, countries_iso) %>%
  mutate(countries_iso = map_chr(countries_iso, ~paste(., collapse = ", "))) # Convertir lista a texto para la tabla

datatable(display_table,
          colnames = c("Año", "Revista", "Tipo", "Autores", "Afiliaciones", "Países ISO"),
          filter = 'top',
          extensions = 'Buttons',
          options = list(
            pageLength = 10, 
            dom = 'Bfrtip',
            buttons = c('csv', 'excel'),
            scrollX = TRUE
          ),
          rownames = FALSE)
```
